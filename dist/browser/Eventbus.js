function e(e,t){return function(e,t){return t.get?t.get.call(e):t.value}(e,s(e,t,"get"))}function t(e,t,r){return function(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=s}}(e,s(e,t,"set"),r),r}function s(e,t,s){if(!t.has(e))throw new TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}const r=/\s+/;function n(e,t,s,o,a){let c,h=0;if(s&&"object"==typeof s){void 0!==o&&"context"in a&&void 0===a.context&&(a.context=o);for(c=i(s);h<c.length;h++)t=n(e,t,c[h],s[c[h]],a)}else if(s&&r.test(s))for(c=s.split(r);h<c.length;h++)t=e(t,c[h],o,a);else t=e(t,s,o,a);return t}const i=e=>null===e||"object"!=typeof e?[]:Object.keys(e);function o(e,t,s,r){const n=r.after,i=r.count+1;if(s){const r=e[t]=a(i,(function(){return s.apply(this,arguments)}),(()=>{n(t,r)}));r._callback=s}return e}const a=function(e,t,s){let r;return function(...n){return--e>0&&(r=t.apply(this,n)),e<=1&&(s&&s.apply(this,n),s=void 0,t=void 0),r}};var c=new WeakMap,h=new WeakMap;class l{constructor(e){c.set(this,{writable:!0,value:void 0}),h.set(this,{writable:!0,value:void 0}),t(this,c,e)}before(t,s,r,i,a=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(!Number.isInteger(t))throw new TypeError("'count' is not an integer");const h={};if(e(this,c).isGuarded(s,h))return console.warn(`@typhonjs-plugin/eventbus - before() failed as event name(s) are guarded: ${JSON.stringify(h.names)}`),this;const l=n(o,{},s,r,{count:t,after:this.off.bind(this)});return"string"==typeof s&&null==i&&(r=void 0),this.on(l,r,i,a)}destroy(){null!==e(this,c)&&this.off(),t(this,h,void 0),t(this,c,null)}*entries(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");for(const s of e(this,c).entries(t))yield s}get eventCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).eventCount}get callbackCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).callbackCount}*keys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");for(const s of e(this,c).keys(t))yield s}get isDestroyed(){return null===e(this,c)}get name(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).name}get proxyEventCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,h)?Object.keys(e(this,h)).length:0}get proxyCallbackCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(!e(this,h))return 0;let t=0;for(const s in e(this,h))t+=e(this,h)[s].length;return t}isGuarded(t,s={}){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).isGuarded(t,s)}off(s,r,i){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return t(this,h,n(u,e(this,h)||{},s,r,{context:i,eventbus:e(this,c)})),this}on(s,r,i,o=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");const a={};if(e(this,c).isGuarded(s,a))return console.warn(`@typhonjs-plugin/eventbus - on() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this;let l;return l=null!==s&&"object"==typeof s?void 0!==r?r:this:i||this,t(this,h,n(d,e(this,h)||{},s,r,{context:l,guarded:o})),e(this,c).on(s,r,l,o),this}once(t,s,r,i=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");const a={};if(e(this,c).isGuarded(t,a))return console.warn(`@typhonjs-plugin/eventbus - once() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this;const h=n(o,{},t,s,{count:1,after:this.off.bind(this)});return"string"==typeof t&&null==r&&(s=void 0),this.on(h,s,r,i)}*proxyEntries(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,h))if(t){for(const s in e(this,h))if(t.test(s))for(const t of e(this,h)[s])yield[s,t.callback,t.context,t.guarded]}else for(const t in e(this,h))for(const s of e(this,h)[t])yield[t,s.callback,s.context,s.guarded]}*proxyKeys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,h))if(t)for(const s in e(this,h))t.test(s)&&(yield s);else for(const t in e(this,h))yield t}trigger(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).trigger(...arguments),this}triggerAsync(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).triggerAsync(...arguments)}triggerDefer(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).triggerDefer(...arguments),this}triggerSync(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,c).triggerSync(...arguments)}}const u=(e,t,s,r)=>{if(!e)return;const n=r.context,o=r.eventbus,a=t?[t]:i(e);for(let r=0;r<a.length;r++){const i=e[t=a[r]];if(!i)break;const c=[];for(let e=0;e<i.length;e++){const t=i[e];(s&&s!==t.callback&&s!==t.callback._callback||n&&n!==t.context)&&c.push(t)}c.length?e[t]=c:(o.off(t,s,n),delete e[t])}return e},d=(e,t,s,r)=>{if(s){const n=e[t]||(e[t]=[]),i=r.context,o="boolean"==typeof r.guarded&&r.guarded;n.push({callback:s,context:i,guarded:o})}return e};var f=new WeakMap;class g{constructor(){f.set(this,{writable:!0,value:void 0})}static initialize(s){const r=new g;return t(r,f,s),{destroy:function(){null!==e(r,f)&&(t(r,f,null),this&&(this.eventbusSecure=void 0))},setEventbus:function(s){null!==e(r,f)&&t(r,f,s)},eventbusSecure:r}}get eventCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,f).callbackCount}*keys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");for(const s of e(this,f).keys(t))yield s}get isDestroyed(){return null===e(this,f)}get name(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,f).name}trigger(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,f).trigger(...arguments),this}triggerAsync(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,f).triggerAsync(...arguments)}triggerDefer(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,f).triggerDefer(...arguments),this}triggerSync(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,f).triggerSync(...arguments)}}var y=new WeakMap,b=new WeakMap;let v;var w=new WeakMap,p=new WeakMap,x=new WeakMap,E=new WeakMap,k=new WeakMap,T=new WeakMap;class m{constructor(e,s){w.set(this,{writable:!0,value:void 0}),p.set(this,{writable:!0,value:void 0}),x.set(this,{writable:!0,value:void 0}),E.set(this,{writable:!0,value:void 0}),k.set(this,{writable:!0,value:void 0}),T.set(this,{writable:!0,value:0}),t(this,p,e._listenId),t(this,x,e),t(this,E,s),t(this,k,!0)}cleanup(){delete e(this,x)._listeningTo[e(this,E)._listenId],e(this,k)||delete e(this,E)._listeners[e(this,p)]}get id(){return e(this,p)}get interop(){return e(this,k)}get obj(){return e(this,E)}incrementCount(){t(this,T,+e(this,T)+1)}on(s,r,i){return t(this,w,n(P,e(this,w)||{},s,r,{context:i,ctx:this,listening:this})),this}off(s,r){let i;e(this,k)?(t(this,w,n(D,e(this,w),s,r,{context:void 0,listeners:void 0})),i=!e(this,w)):(t(this,T,+e(this,T)-1),i=0===e(this,T)),i&&this.cleanup()}set interop(e){if("boolean"!=typeof e)throw new TypeError("'value' is not a boolean");t(this,k,e)}}const R=(e,t,s,r)=>{const n=r.events;if(n){const s=n[t];Array.isArray(s)&&1===s.length&&"boolean"==typeof s[0].guarded&&s[0].guarded&&(e.names.push(t),e.guarded=!0)}return e},D=(e,t,s,r)=>{if(!e)return;const n=r.context,o=r.listeners;let a,c=0;if(t||n||s){for(a=t?[t]:i(e);c<a.length;c++){const r=e[t=a[c]];if(!r)break;const i=[];for(let e=0;e<r.length;e++){const o=r[e];if(s&&s!==o.callback&&s!==o.callback._callback||n&&n!==o.context)i.push(o);else{const e=o.listening;e&&e.off(t,s)}}i.length?e[t]=i:delete e[t]}return e}for(a=i(o);c<a.length;c++)o[a[c]].cleanup()},P=(e,t,s,r)=>{if(s){const n=e[t]||(e[t]=[]),i=r.context,o=r.ctx,a=r.listening,c="boolean"==typeof r.guarded&&r.guarded;if(1===n.length&&"boolean"==typeof n[0].guarded&&n[0].guarded)return console.warn("@typhonjs-plugin/eventbus - s_ON_API failed as event name is guarded."),e;a&&a.incrementCount(),n.push({callback:s,context:i,ctx:i||o,guarded:c,listening:a})}return e},_=(e,t,s,n,i,o)=>{let a,c,h=0;if(n&&r.test(n))for(c=n.split(r);h<c.length;h++){const r=e(t,s,c[h],i,o),n=Array.isArray(a)?2:void 0!==a?1:0;if(Array.isArray(r))switch(n){case 0:a=r;break;case 1:a=[a].concat(r);break;case 2:a=a.concat(r)}else if(void 0!==r)switch(n){case 0:a=r;break;case 1:{const e=[a];e.push(r),a=e;break}case 2:a.push(r)}}else a=e(t,s,n,i,o);return a},S=(e,t,s,r,n)=>{let i;if(t){const r=t[s];let o=t.all;r&&o&&(o=o.slice()),r&&(i=e(r,n)),o&&(i=e(o,[s].concat(n)))}return i},A=(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length;switch(t.length){case 0:for(;++r<a;)(s=e[r]).callback.call(s.ctx);return;case 1:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n);return;case 2:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n,i);return;case 3:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n,i,o);return;default:for(;++r<a;)(s=e[r]).callback.apply(s.ctx,t);return}},j=async(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length,c=[];try{switch(t.length){case 0:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx);void 0!==t&&c.push(t)}break;case 1:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n);void 0!==t&&c.push(t)}break;case 2:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i);void 0!==t&&c.push(t)}break;case 3:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i,o);void 0!==t&&c.push(t)}break;default:for(;++r<a;){const n=(s=e[r]).callback.apply(s.ctx,t);void 0!==n&&c.push(n)}}}catch(e){return Promise.reject(e)}return c.length>1?Promise.all(c).then((e=>{const t=e.filter((e=>void 0!==e));switch(t.length){case 0:return;case 1:return t[0];default:return t}})):1===c.length?Promise.resolve(c[0]):Promise.resolve()},M=(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length,c=[];switch(t.length){case 0:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx);void 0!==t&&c.push(t)}break;case 1:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n);void 0!==t&&c.push(t)}break;case 2:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i);void 0!==t&&c.push(t)}break;case 3:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i,o);void 0!==t&&c.push(t)}break;default:for(;++r<a;){const n=(s=e[r]).callback.apply(s.ctx,t);void 0!==n&&c.push(n)}}return c.length>1?c:1===c.length?c[0]:void 0};let C=0;const I=(e="")=>{const t=""+ ++C;return e?`${e}${t}`:t};export default class{constructor(e=""){if(y.set(this,{writable:!0,value:""}),b.set(this,{writable:!0,value:void 0}),"string"!=typeof e)throw new TypeError("'eventbusName' is not a string");t(this,y,e),this._listeners=void 0,this._listenId=void 0,this._listeningTo=void 0}before(e,t,s,r,i=!1){if(!Number.isInteger(e))throw new TypeError("'count' is not an integer");const a={};if(this.isGuarded(t,a))return console.warn(`@typhonjs-plugin/eventbus - before() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this;const c=n(o,{},t,s,{count:e,after:this.off.bind(this)});return"string"==typeof t&&null==r&&(s=void 0),this.on(c,s,r,i)}createProxy(){return new l(this)}createSecure(){return g.initialize(this)}*entries(t){if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,b))if(t){for(const s in e(this,b))if(t.test(s))for(const t of e(this,b)[s])yield[s,t.callback,t.ctx,t.guarded]}else for(const t in e(this,b))for(const s of e(this,b)[t])yield[t,s.callback,s.ctx,s.guarded]}get eventCount(){return e(this,b)?Object.keys(e(this,b)).length:0}get callbackCount(){if(!e(this,b))return 0;let t=0;for(const s in e(this,b))t+=e(this,b)[s].length;return t}isGuarded(t,s={}){return s.names=[],s.guarded=!1,n(R,s,t,void 0,{events:e(this,b)}).guarded}*keys(t){if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,b))if(t)for(const s in e(this,b))t.test(s)&&(yield s);else for(const t in e(this,b))yield t}get name(){return e(this,y)}listenTo(e,t,s){if(!e)return this;const r={};if(((e,t,s={})=>{let r=!1;try{const n=e.isGuarded(t,s);"boolean"==typeof n&&(r=n)}catch(e){r=!1,s.names=[],s.guarded=!1}return r})(e,t,r))return console.warn(`@typhonjs-plugin/eventbus - listenTo() failed as event name(s) are guarded for target object: ${JSON.stringify(r.names)}`),this;const n=e._listenId||(e._listenId=I("l")),i=this._listeningTo||(this._listeningTo={});let o=v=i[n];o||(this._listenId||(this._listenId=I("l")),o=v=i[n]=new m(this,e));const a=((e,t,s,r)=>{try{e.on(t,s,r)}catch(e){return e}})(e,t,s,this);if(v=void 0,a)throw a;return o.interop&&o.on(t,s),this}listenToBefore(e,t,s,r){if(!Number.isInteger(e))throw new TypeError("'count' is not an integer");const i=n(o,{},s,r,{count:e,after:this.stopListening.bind(this,t)});return this.listenTo(t,i)}listenToOnce(e,t,s){const r=n(o,{},t,s,{count:1,after:this.stopListening.bind(this,e)});return this.listenTo(e,r)}off(s,r,i){return e(this,b)?(t(this,b,n(D,e(this,b),s,r,{context:i,listeners:this._listeners})),this):this}on(s,r,i,o=!1){const a={};return this.isGuarded(s,a)?(console.warn(`@typhonjs-plugin/eventbus - on() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this):(t(this,b,n(P,e(this,b)||{},s,r,{context:i,ctx:this,guarded:o,listening:v})),v&&((this._listeners||(this._listeners={}))[v.id]=v,v.interop=!1),this)}once(e,t,s,r=!1){const i={};if(this.isGuarded(e,i))return console.warn(`@typhonjs-plugin/eventbus - once() failed as event name(s) are guarded: ${JSON.stringify(i.names)}`),this;const a=n(o,{},e,t,{count:1,after:this.off.bind(this)});return"string"==typeof e&&null==s&&(t=void 0),this.on(a,t,s,r)}stopListening(e,t,s){const r=this._listeningTo;if(!r)return this;const n=e?[e._listenId]:i(r);for(let e=0;e<n.length;e++){const i=r[n[e]];if(!i)break;i.obj.off(t,s,this),i.interop&&i.off(t,s)}return this}trigger(t){if(!e(this,b))return this;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];return _(S,A,e(this,b),t,void 0,r),this}async triggerAsync(t){if(!e(this,b))return;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];const n=_(S,j,e(this,b),t,void 0,r);return void 0!==n?Array.isArray(n)?Promise.all(n).then((e=>{let t=[];for(const s of e)Array.isArray(s)?t=t.concat(s):void 0!==s&&t.push(s);return t.length>1?t:1===t.length?t[0]:void 0})):n:void 0}triggerDefer(e){return setTimeout((()=>{this.trigger(...arguments)}),0),this}triggerSync(t){if(!e(this,b))return;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];return _(S,M,e(this,b),t,void 0,r)}}export{l as EventbusProxy,g as EventbusSecure};
//# sourceMappingURL=Eventbus.js.map
