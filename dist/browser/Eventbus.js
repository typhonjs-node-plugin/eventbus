function e(e,t){return function(e,t){return t.get?t.get.call(e):t.value}(e,s(e,t,"get"))}function t(e,t,r){return function(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=s}}(e,s(e,t,"set"),r),r}function s(e,t,s){if(!t.has(e))throw new TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}const r=/\s+/;function n(e,t,s,o,a){let c,h=0;if(s&&"object"==typeof s){void 0!==o&&"context"in a&&void 0===a.context&&(a.context=o);for(c=i(s);h<c.length;h++)t=n(e,t,c[h],s[c[h]],a)}else if(s&&r.test(s))for(c=s.split(r);h<c.length;h++)t=e(t,c[h],o,a);else t=e(t,s,o,a);return t}const i=e=>null===e||"object"!=typeof e?[]:Object.keys(e);function o(e,t,s,r){const n=r.after,i=r.count+1;if(s){const r=e[t]=a(i,(function(){return s.apply(this,arguments)}),(()=>{n(t,r)}));r._callback=s}return e}const a=function(e,t,s){let r;return function(...n){return--e>0&&(r=t.apply(this,n)),e<=1&&(s&&s.apply(this,n),s=void 0,t=void 0),r}};var c=new WeakMap,h=new WeakMap;class l{constructor(){c.set(this,{writable:!0,value:void 0}),h.set(this,{writable:!0,value:void 0})}static initialize(s,r){if(void 0!==r&&"string"!=typeof r)throw new TypeError("'name' is not a string");const n=new l;return t(n,c,s),t(n,h,void 0===r?s.name:r),{destroy:function(){n.isDestroyed||(t(n,c,null),this&&(this.eventbusSecure=void 0))},setEventbus:function(s,r){if(void 0!==r&&"string"!=typeof r)throw new TypeError("'name' is not a string");n.isDestroyed||(void 0===r&&e(n,h)===e(n,c).name?t(n,h,s.name):void 0!==r&&t(n,h,r),t(n,c,s))},eventbusSecure:n}}*keys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");for(const s of e(this,c).keys(t))yield s}get isDestroyed(){return null===e(this,c)}get name(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,h)}trigger(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,c).trigger(...arguments),this}triggerAsync(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,c).triggerAsync(...arguments)}triggerDefer(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,c).triggerDefer(...arguments),this}triggerSync(){if(this.isDestroyed)throw new ReferenceError("This EventbusSecure instance has been destroyed.");return e(this,c).triggerSync(...arguments)}}var u=new WeakMap,f=new WeakMap;class d{constructor(e){u.set(this,{writable:!0,value:void 0}),f.set(this,{writable:!0,value:void 0}),t(this,u,e)}before(t,s,r,i,a=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(!Number.isInteger(t))throw new TypeError("'count' is not an integer");const c={};if(e(this,u).isGuarded(s,c))return console.warn(`@typhonjs-plugin/eventbus - before() failed as event name(s) are guarded: ${JSON.stringify(c.names)}`),this;const h=n(o,{},s,r,{count:t,after:this.off.bind(this)});return"string"==typeof s&&null==i&&(r=void 0),this.on(h,r,i,a)}createSecure(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return l.initialize(e(this,u),t)}destroy(){null!==e(this,u)&&this.off(),t(this,f,void 0),t(this,u,null)}*entries(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");for(const s of e(this,u).entries(t))yield s}get eventCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,u).eventCount}get callbackCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,u).callbackCount}*keys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");for(const s of e(this,u).keys(t))yield s}get isDestroyed(){return null===e(this,u)}get name(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return`proxy-${e(this,u).name}`}get proxyEventCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,f)?Object.keys(e(this,f)).length:0}get proxyCallbackCount(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(!e(this,f))return 0;let t=0;for(const s in e(this,f))t+=e(this,f)[s].length;return t}isGuarded(t,s={}){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,u).isGuarded(t,s)}off(s,r,i){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return t(this,f,n(y,e(this,f)||{},s,r,{context:i,eventbus:e(this,u)})),this}on(s,r,i,o=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");const a={};if(e(this,u).isGuarded(s,a))return console.warn(`@typhonjs-plugin/eventbus - on() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this;const c={context:i,ctx:this,guarded:o};return t(this,f,n(g,e(this,f)||{},s,r,c)),e(this,u).on(s,r,c.ctx,o),this}once(t,s,r,i=!1){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");const a={};if(e(this,u).isGuarded(t,a))return console.warn(`@typhonjs-plugin/eventbus - once() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this;const c=n(o,{},t,s,{count:1,after:this.off.bind(this)});return"string"==typeof t&&null==r&&(s=void 0),this.on(c,s,r,i)}*proxyEntries(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,f))if(t){for(const s in e(this,f))if(t.test(s))for(const t of e(this,f)[s])yield[s,t.callback,t.context,t.guarded]}else for(const t in e(this,f))for(const s of e(this,f)[t])yield[t,s.callback,s.context,s.guarded]}*proxyKeys(t){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,f))if(t)for(const s in e(this,f))t.test(s)&&(yield s);else for(const t in e(this,f))yield t}trigger(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,u).trigger(...arguments),this}triggerAsync(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,u).triggerAsync(...arguments)}triggerDefer(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,u).triggerDefer(...arguments),this}triggerSync(){if(this.isDestroyed)throw new ReferenceError("This EventbusProxy instance has been destroyed.");return e(this,u).triggerSync(...arguments)}}const y=(e,t,s,r)=>{if(!e)return;const n=r.context,o=r.eventbus,a=t?[t]:i(e);for(let r=0;r<a.length;r++){const i=e[t=a[r]];if(!i)break;const c=[];for(let e=0;e<i.length;e++){const t=i[e];(s&&s!==t.callback&&s!==t.callback._callback||n&&n!==t.context)&&c.push(t)}c.length?e[t]=c:(o.off(t,s,n),delete e[t])}return e},g=(e,t,s,r)=>{if(s){const n=e[t]||(e[t]=[]),i=r.context,o=r.ctx,a="boolean"==typeof r.guarded&&r.guarded;r.ctx=i||o,n.push({callback:s,context:i,ctx:r.ctx,guarded:a})}return e};var b=new WeakMap,v=new WeakMap;class w{constructor(e=""){if(b.set(this,{writable:!0,value:""}),v.set(this,{writable:!0,value:void 0}),"string"!=typeof e)throw new TypeError("'eventbusName' is not a string");t(this,b,e),this._listeners=void 0,this._listenId=void 0,this._listeningTo=void 0}before(e,t,s,r,i=!1){if(!Number.isInteger(e))throw new TypeError("'count' is not an integer");const a={};if(this.isGuarded(t,a))return console.warn(`@typhonjs-plugin/eventbus - before() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this;const c=n(o,{},t,s,{count:e,after:this.off.bind(this)});return"string"==typeof t&&null==r&&(s=void 0),this.on(c,s,r,i)}createProxy(){return new d(this)}createSecure(e){return l.initialize(this,e)}*entries(t){if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,v))if(t){for(const s in e(this,v))if(t.test(s))for(const t of e(this,v)[s])yield[s,t.callback,t.context,t.guarded]}else for(const t in e(this,v))for(const s of e(this,v)[t])yield[t,s.callback,s.context,s.guarded]}get eventCount(){return e(this,v)?Object.keys(e(this,v)).length:0}get callbackCount(){if(!e(this,v))return 0;let t=0;for(const s in e(this,v))t+=e(this,v)[s].length;return t}isGuarded(t,s={}){return s.names=[],s.guarded=!1,n(P,s,t,void 0,{events:e(this,v)}).guarded}*keys(t){if(void 0!==t&&!(t instanceof RegExp))throw new TypeError("'regex' is not a RegExp");if(e(this,v))if(t)for(const s in e(this,v))t.test(s)&&(yield s);else for(const t in e(this,v))yield t}get name(){return e(this,b)}listenTo(e,t,s){if(!e)return this;const r={};if(I(e,t,r))return console.warn(`@typhonjs-plugin/eventbus - listenTo() failed as event name(s) are guarded for target object: ${JSON.stringify(r.names)}`),this;const n=e._listenId||(e._listenId=G("l")),i=this._listeningTo||(this._listeningTo={});let o=p=i[n];o||(this._listenId||(this._listenId=G("l")),o=p=i[n]=new R(this,e));const a=N(e,t,s,this);if(p=void 0,a)throw a;return o.interop&&o.on(t,s),this}listenToBefore(e,t,s,r){if(!Number.isInteger(e))throw new TypeError("'count' is not an integer");const i=n(o,{},s,r,{count:e,after:this.stopListening.bind(this,t)});return this.listenTo(t,i)}listenToOnce(e,t,s){const r=n(o,{},t,s,{count:1,after:this.stopListening.bind(this,e)});return this.listenTo(e,r)}off(s,r,i){return e(this,v)?(t(this,v,n(S,e(this,v),s,r,{context:i,listeners:this._listeners})),this):this}on(s,r,i,o=!1){const a={};return this.isGuarded(s,a)?(console.warn(`@typhonjs-plugin/eventbus - on() failed as event name(s) are guarded: ${JSON.stringify(a.names)}`),this):(t(this,v,n(_,e(this,v)||{},s,r,{context:i,ctx:this,guarded:o,listening:p})),p&&((this._listeners||(this._listeners={}))[p.id]=p,p.interop=!1),this)}once(e,t,s,r=!1){const i={};if(this.isGuarded(e,i))return console.warn(`@typhonjs-plugin/eventbus - once() failed as event name(s) are guarded: ${JSON.stringify(i.names)}`),this;const a=n(o,{},e,t,{count:1,after:this.off.bind(this)});return"string"==typeof e&&null==s&&(t=void 0),this.on(a,t,s,r)}stopListening(e,t,s){const r=this._listeningTo;if(!r)return this;const n=e?[e._listenId]:i(r);for(let e=0;e<n.length;e++){const i=r[n[e]];if(!i)break;i.obj.off(t,s,this),i.interop&&i.off(t,s)}return this}trigger(t){if(!e(this,v))return this;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];return A(j,M,e(this,v),t,void 0,r),this}async triggerAsync(t){if(!e(this,v))return;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];const n=A(j,W,e(this,v),t,void 0,r);return void 0!==n?Array.isArray(n)?Promise.all(n).then((e=>{let t=[];for(const s of e)Array.isArray(s)?t=t.concat(s):void 0!==s&&t.push(s);return t.length>1?t:1===t.length?t[0]:void 0})):n:void 0}triggerDefer(e){return setTimeout((()=>{this.trigger(...arguments)}),0),this}triggerSync(t){if(!e(this,v))return;const s=Math.max(0,arguments.length-1),r=new Array(s);for(let e=0;e<s;e++)r[e]=arguments[e+1];return A(j,C,e(this,v),t,void 0,r)}}let p;var x=new WeakMap,E=new WeakMap,k=new WeakMap,T=new WeakMap,m=new WeakMap,D=new WeakMap;class R{constructor(e,s){x.set(this,{writable:!0,value:void 0}),E.set(this,{writable:!0,value:void 0}),k.set(this,{writable:!0,value:void 0}),T.set(this,{writable:!0,value:void 0}),m.set(this,{writable:!0,value:void 0}),D.set(this,{writable:!0,value:0}),t(this,E,e._listenId),t(this,k,e),t(this,T,s),t(this,m,!0)}cleanup(){delete e(this,k)._listeningTo[e(this,T)._listenId],e(this,m)||delete e(this,T)._listeners[e(this,E)]}get id(){return e(this,E)}get interop(){return e(this,m)}get obj(){return e(this,T)}incrementCount(){t(this,D,+e(this,D)+1)}on(s,r,i){return t(this,x,n(_,e(this,x)||{},s,r,{context:i,ctx:this,listening:this})),this}off(s,r){let i;e(this,m)?(t(this,x,n(S,e(this,x),s,r,{context:void 0,listeners:void 0})),i=!e(this,x)):(t(this,D,+e(this,D)-1),i=0===e(this,D)),i&&this.cleanup()}set interop(e){if("boolean"!=typeof e)throw new TypeError("'value' is not a boolean");t(this,m,e)}}const P=(e,t,s,r)=>{const n=r.events;if(n){const s=n[t];if(Array.isArray(s))for(const r of s)if(r.guarded)return e.names.push(t),e.guarded=!0,e}return e},S=(e,t,s,r)=>{if(!e)return;const n=r.context,o=r.listeners;let a,c=0;if(t||n||s){for(a=t?[t]:i(e);c<a.length;c++){const r=e[t=a[c]];if(!r)break;const i=[];for(let e=0;e<r.length;e++){const o=r[e];if(s&&s!==o.callback&&s!==o.callback._callback||n&&n!==o.context)i.push(o);else{const e=o.listening;e&&e.off(t,s)}}i.length?e[t]=i:delete e[t]}return e}for(a=i(o);c<a.length;c++)o[a[c]].cleanup()},_=(e,t,s,r)=>{if(s){const n=e[t]||(e[t]=[]),i=r.context,o=r.ctx,a=r.listening,c="boolean"==typeof r.guarded&&r.guarded;a&&a.incrementCount(),n.push({callback:s,context:i,ctx:i||o,guarded:c,listening:a})}return e},A=(e,t,s,n,i,o)=>{let a,c,h=0;if(n&&r.test(n))for(c=n.split(r);h<c.length;h++){const r=e(t,s,c[h],i,o),n=Array.isArray(a)?2:void 0!==a?1:0;if(Array.isArray(r))switch(n){case 0:a=r;break;case 1:a=[a].concat(r);break;case 2:a=a.concat(r)}else if(void 0!==r)switch(n){case 0:a=r;break;case 1:{const e=[a];e.push(r),a=e;break}case 2:a.push(r)}}else a=e(t,s,n,i,o);return a},j=(e,t,s,r,n)=>{let i;if(t){const r=t[s];let o=t.all;r&&o&&(o=o.slice()),r&&(i=e(r,n)),o&&(i=e(o,[s].concat(n)))}return i},M=(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length;switch(t.length){case 0:for(;++r<a;)(s=e[r]).callback.call(s.ctx);return;case 1:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n);return;case 2:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n,i);return;case 3:for(;++r<a;)(s=e[r]).callback.call(s.ctx,n,i,o);return;default:for(;++r<a;)(s=e[r]).callback.apply(s.ctx,t);return}},W=async(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length,c=[];try{switch(t.length){case 0:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx);void 0!==t&&c.push(t)}break;case 1:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n);void 0!==t&&c.push(t)}break;case 2:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i);void 0!==t&&c.push(t)}break;case 3:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i,o);void 0!==t&&c.push(t)}break;default:for(;++r<a;){const n=(s=e[r]).callback.apply(s.ctx,t);void 0!==n&&c.push(n)}}}catch(e){return Promise.reject(e)}return c.length>1?Promise.all(c).then((e=>{const t=e.filter((e=>void 0!==e));switch(t.length){case 0:return;case 1:return t[0];default:return t}})):1===c.length?Promise.resolve(c[0]):Promise.resolve()},C=(e,t)=>{let s,r=-1;const n=t[0],i=t[1],o=t[2],a=e.length,c=[];switch(t.length){case 0:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx);void 0!==t&&c.push(t)}break;case 1:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n);void 0!==t&&c.push(t)}break;case 2:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i);void 0!==t&&c.push(t)}break;case 3:for(;++r<a;){const t=(s=e[r]).callback.call(s.ctx,n,i,o);void 0!==t&&c.push(t)}break;default:for(;++r<a;){const n=(s=e[r]).callback.apply(s.ctx,t);void 0!==n&&c.push(n)}}return c.length>1?c:1===c.length?c[0]:void 0},I=(e,t,s={})=>{let r=!1;try{const n=e.isGuarded(t,s);"boolean"==typeof n&&(r=n)}catch(e){r=!1,s.names=[],s.guarded=!1}return r},N=(e,t,s,r)=>{try{e.on(t,s,r)}catch(e){return e}};let O=0;const G=(e="")=>{const t=""+ ++O;return e?`${e}${t}`:t},$=new w("mainEventbus"),J=new w("pluginEventbus"),z=new w("testEventbus");export default w;export{d as EventbusProxy,l as EventbusSecure,$ as eventbus,J as pluginEventbus,z as testEventbus};
//# sourceMappingURL=Eventbus.js.map
